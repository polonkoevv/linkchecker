# Link Checker

Веб-сервис для проверки доступности интернет-ресурсов с генерацией PDF отчетов.

## Функциональность

- Проверка доступности ссылок (по одной или несколько)
- Присвоение номера группы проверенным ссылкам
- Генерация PDF/JSON отчетов по группам ссылок
- Получение всех сохраненных групп ссылок

## Архитектура

Проект использует слоистую архитектуру:

- **cmd/** - точка входа приложения
- **internal/api/http/** - HTTP handlers и middleware
- **internal/service/** - бизнес-логика
- **internal/storage/** - хранилище данных (in-memory с JSON persistence)
- **internal/urlchecker/** - проверка доступности URL
- **internal/pdfgenerator/** - генерация PDF отчетов
- **internal/config/** - конфигурация
- **internal/logger/** - логирование

## Паттерны и практики

### Worker Pool

Проверка ссылок выполняется через worker pool паттерн (`internal/service/link/link_service.go`):

- Настраиваемое количество воркеров (по умолчанию 4, настраивается через `MAX_WORKERS_NUM`)
- Параллельная обработка ссылок через каналы
- Автоматическая дедупликация ссылок
- Обработка отмены через context

### Graceful Shutdown

Приложение поддерживает корректное завершение работы:

- Обработка сигналов SIGTERM/SIGINT
- Завершение активных HTTP запросов (таймаут 5 секунд)
- Сохранение состояния хранилища в JSON файл перед завершением
- Обработка новых запросов во время shutdown

### Обработка ошибок

Многоуровневая обработка ошибок:

1. **Middleware** - валидация запросов (Content-Type, размер тела, структура JSON)
2. **Handlers** - бизнес-валидация и обработка ошибок сервиса
3. **Service** - обработка ошибок репозитория и внешних вызовов
4. **Storage** - частичные результаты при отсутствии некоторых групп

Коды ответов:
- `400` - ошибки валидации
- `408` - таймауты запросов
- `413` - превышение размера тела запроса (1 MB)
- `415` - неподдерживаемый Content-Type
- `500` - внутренние ошибки сервера

### Persistence

In-memory хранилище с JSON persistence:

- Автоматическая загрузка данных при старте (`LoadFromFile`)
- Атомарное сохранение через временный файл (`SaveToFile`)
- Thread-safe операции через `sync.RWMutex`
- Частичные результаты при запросе несуществующих групп

## Конфигурация

Конфигурация через переменные окружения (`.env` файл или системные переменные):

- `HOST`, `PORT` - адрес сервера (по умолчанию: localhost:8080)
- `MAX_WORKERS_NUM` - количество воркеров (по умолчанию: 4)
- `REQUEST_TIMEOUT` - таймаут запроса в секундах (по умолчанию: 30)
- `READ_TIMEOUT`, `WRITE_TIMEOUT`, `IDLE_TIMEOUT` - таймауты HTTP сервера
- `LEVEL_INFO` - уровень логирования (debug/info/warn/error)
- `LOGGING_PATH` - путь к файлу логов
- `FILE_STORAGE_PATH` - путь к файлу хранилища

Все параметры имеют значения по умолчанию.

## API

API описано в OpenAPI 3.0 спецификации (`openapi.yml`).

Эндпоинты:
- `POST /links` - проверка ссылок
- `GET /links` - получение всех групп
- `POST /report` - генерация отчета (PDF или JSON)

## Тестирование

Проект включает unit-тесты для критичных компонентов:

- `internal/storage/inmemory/` - тесты хранилища (InsertMany, GetByNums, GetAll)
- `internal/service/link/` - тесты бизнес-логики (CheckMany, GenerateReport, GetAll)
- Покрытие тестами проверяется через `go test -cover`

Тесты используют моки для изоляции зависимостей (repository, urlChecker, pdfGenerator).

Команды:
- `make test` - запуск всех тестов
- `make test-cover` - тесты с покрытием
- `make test-html` - HTML отчет о покрытии

## Сборка и запуск

```bash
# Сборка
make build

# Запуск
make run

# Форматирование кода
make fmt

# Проверка линтером
make lint

# Полная проверка (fmt + lint + test + build)
make all
```

## Зависимости

- `github.com/joho/godotenv` - загрузка переменных окружения
- `github.com/jung-kurt/gofpdf` - генерация PDF отчетов
